<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survey Map App v13.2 - Final Edition</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <style>
        /* Âü∫Á§éÊ®£Âºè [cite: 1-4] */
        body { margin:0; padding:0; display:flex; height:100vh; font-family:-apple-system,Arial,sans-serif; overflow:hidden; background:#f0f2f5; flex-direction: column; }
        #map-container { display:none; flex:1; position:relative; }
        #map { width:100%; height:100%; z-index:1; }

        /* GPS Ë≥áË®äÊ°Ü [cite: 5-7] */
        #gps-coords-box {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            z-index: 9999; background: rgba(0, 0, 0, 0.85);
            color: #00ff00; padding: 8px 15px; border-radius: 20px;
            font-size: 15px; font-family: monospace; font-weight: bold;
            display: none; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 2px solid #ffffff33; pointer-events: none; text-align: center;
        }

        /* Áî®Êà∂‰ΩçÁΩÆÊ®ôË®ò [cite: 8-14] */
        .user-location-marker { position: relative; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .location-dot { width: 12px; height: 12px; background-color: #4285F4; border: 2px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 2; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .location-beam { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid rgba(66, 133, 244, 0.3); border-radius: 40% 40% 0 0; position: absolute; top: -20px; left: 0; transform-origin: center 40px; z-index: 1; transition: transform 0.1s linear; display: none; }

        /* ‰∏ªÁïåÈù¢ËàáÊåâÈàïÁµÑ [cite: 15-41] */
        #home-screen { flex:1; background: linear-gradient(135deg, #007bff, #0056b3); z-index:9000; display:flex; flex-direction:column; align-items:center; padding: 20px; overflow-y: auto; }
        .app-title { color:white; font-size:24px; font-weight:bold; margin:30px 0 10px 0; }
        #menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 500px; padding-bottom: 50px; }
        .menu-btn { background: rgba(255,255,255,0.95); border-radius: 12px; height: 85px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; }
        
        .btn-group-container { position:absolute; top:10px; left:10px; z-index:3000; display:flex; flex-direction:column; gap:10px; }
        .btn-expandable { display: none; flex-direction: column; gap: 10px; }
        .btn-expandable.show { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-float { width:44px; height:44px; background:white; border-radius:8px; border:none; box-shadow:0 2px 5px rgba(0,0,0,0.3); font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
        #gps-btn.active { color:#007bff; border:2px solid #007bff; background:#eef; }
        #fullscreen-btn.active { background: #28a745; color: white; }

        /* ÂÅ¥ÈÇäÊ¨ÑËàáÁØ©ÈÅ∏ [cite: 49-65] */
        #sidebar { position:absolute; left:0; top:0; bottom:0; width:320px; background:white; z-index:4000; transform:translateX(-100%); transition:transform 0.3s; box-shadow:2px 0 10px rgba(0,0,0,0.2); display:flex; flex-direction:column; }
        #sidebar.open { transform:translateX(0); }
        .sidebar-header { background:#007bff; color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:16px; }
        .controls { padding:10px; background:#f8f9fa; display:flex; flex-direction:column; gap:10px; border-bottom:1px solid #ddd; }
        .dropdown-check-list { position: relative; flex: 1; }
        .dropdown-check-list .anchor { display:block; padding:8px; border:1px solid #ccc; background:white; cursor:pointer; font-size:12px; border-radius:4px; overflow:hidden; }
        .dropdown-check-list .items { display:none; position:absolute; top:100%; left:0; width:100%; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:5000; }
        .dropdown-check-list.visible .items { display:block; }
        .check-label { display:flex; padding:8px; border-bottom:1px solid #eee; font-size:13px; cursor:pointer; align-items:center; }
        .status-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:5px; border:1px solid rgba(0,0,0,0.1); }
        .damaged-icon { color: red !important; font-weight: 900; font-size: 20px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff; }

        /* ÊâìÂç∞Â†±Ë°®Ê®£Âºè [cite: 96-127, 139] */
        #print-container { display: none; background: white; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 12000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .print-close-btn { position: fixed; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .print-action-btn { position: fixed; top: 10px; right: 80px; background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .report-freq-block { margin-bottom: 20px; border: 2px solid #000; break-inside: avoid; }
        .report-freq-header { background: #f0f0f0; padding: 10px; font-weight: bold; text-align: center; border-bottom: 2px solid #000; }
        .report-details-table { display: table; width: 100%; border-collapse: collapse; }
        .report-type-row { display: table-row; border-bottom: 1px solid #000; }
        .report-type-cell { display: table-cell; padding: 8px; width: 180px; font-weight: bold; background: #fafafa; border-right: 1px solid #000; }
        .report-points-cell { display: table-cell; padding: 8px; font-family: monospace; }
        .print-option-btn.view { background: #e67e22; color: white; }

        @media print { 
            body * { visibility: hidden; } 
            #print-container, #print-container * { visibility: visible; } 
            #print-container { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="app-title">Survey Map App v13.2</div>
        <div id="status-subtitle" style="color:white;margin-bottom:20px">Connecting...</div>
        <div id="menu-grid"></div>
        <div style="margin-top:20px; color:#ccc; font-size:12px; text-decoration:underline; cursor:pointer;" onclick="resetURL()">Reset Connection</div>
    </div>

    <div id="loading-overlay"><div class="spinner"></div><div>Loading...</div></div>

    <div id="setup-box">
        <h3>GitHub App Setup</h3>
        <input type="text" id="url-input" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Paste GAS URL">
        <button onclick="saveURL()" style="background:#007bff; color:white; padding:10px; width:100%; border:none; border-radius:5px;">Connect</button>
    </div>

    <div id="update-modal-overlay"><div class="modal-box" style="background:#222;padding:20px;border-radius:10px;color:white;"><h3 id="modal-title">Install Date</h3><input type="date" id="install-date-picker" style="width:100%;padding:10px;margin:10px 0;"><button onclick="saveInstall()" style="background:#007bff;color:white;border:none;padding:10px;width:100%;">Save</button><button onclick="closeModal()" style="background:#555;color:white;border:none;padding:10px;width:100%;margin-top:5px;">Cancel</button></div></div>
    
    <div id="print-options-overlay">
        <div class="modal-box" style="background:#222;padding:20px;border-radius:10px;color:white;text-align:center;">
            <h3>Select Report Type</h3>
            <button class="print-option-btn simple" onclick="openPrintView('simple')" style="width:100%;padding:12px;margin:5px 0;background:#28a745;color:white;border:none;border-radius:5px;font-weight:bold;">Simplified Version (090~095)</button>
            <button class="print-option-btn detail" onclick="openPrintView('detail')" style="width:100%;padding:12px;margin:5px 0;background:#007bff;color:white;border:none;border-radius:5px;font-weight:bold;">Detailed Version (All)</button>
            <button class="print-option-btn view" onclick="openPrintView('currentView')" style="width:100%;padding:12px;margin:5px 0;background:#e67e22;color:white;border:none;border-radius:5px;font-weight:bold;">Current View Version (Visible Only)</button>
            <button onclick="closePrintOptionsModal()" style="margin-top:10px;background:none;color:#ccc;border:none;cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="print-container">
        <button class="print-close-btn" onclick="closePrintView()">Close</button>
        <button class="print-action-btn" onclick="window.print()">Print PDF</button>
        <div class="print-header"><h2>HSK-C5 Instrumentation Record</h2><div id="print-date"></div></div>
        <div id="print-content"></div>
    </div>

    <div id="map-container">
        <div id="gps-coords-box">Waiting for GPS...</div>
        <div id="measure-box" style="position:absolute;top:10px;left:60px;background:white;padding:10px;z-index:3000;border-radius:5px;display:none;"><div id="measure-dist">Dist: 0.00 m</div><button onclick="clearMeasure()">Clear</button></div>

        <div class="btn-group-container">
            <button class="btn-float btn-main-toggle" onclick="toggleMenu()">‚öôÔ∏è</button>
            <div id="expandable-btns" class="btn-expandable">
                <button class="btn-float" onclick="goHome()">üè†</button>
                <button class="btn-float" onclick="toggleSidebar()">‚ò∞</button>
                <button class="btn-float" id="gps-btn" onclick="toggleGPS()">üéØ</button>
                <button class="btn-float" id="fullscreen-btn" onclick="toggleFullScreen()">‚õ∂</button>
                <button class="btn-float" onclick="toggleMeasure()">üìè</button>
                <button class="btn-float" onclick="toggleZoneBoundaries()">üó∫Ô∏è</button>
                <button class="btn-float" onclick="openPrintOptionsModal()">üìÑ</button>
                <button class="btn-float" onclick="reloadMap()">üîÑ</button>
            </div>
        </div>

        <div id="sidebar">
            <div class="sidebar-header"><span>Project Data</span><span onclick="toggleSidebar()" style="cursor:pointer;">√ó</span></div>
            <div class="controls">
                <div class="filter-row">
                    <div id="zone-dropdown" class="dropdown-check-list"><span class="anchor" onclick="toggleDropdown('zone')">Zones</span><div class="items" id="zone-items"></div></div>
                    <div id="type-dropdown" class="dropdown-check-list"><span class="anchor" onclick="toggleDropdown('type')">Types</span><div class="items" id="type-items"></div></div>
                </div>
                <input type="text" id="search-input" placeholder="Search ID..." onkeyup="applyFilter()" style="width:100%;padding:8px;box-sizing:border-box;">
            </div>
            <div id="list-container"></div>
        </div>
        
        <div id="map"></div>
        
        <div class="legend" style="position:absolute;bottom:15px;left:10px;background:rgba(255,255,255,0.9);padding:5px;z-index:2000;border-radius:5px;">
            <div style="display:flex;align-items:center;margin-bottom:2px;"><span class="status-dot" style="background:red;"></span>Not Installed</div>
            <div style="display:flex;align-items:center;margin-bottom:2px;"><span class="status-dot" style="background:#00e600;"></span>Installed</div>
            <div style="display:flex;align-items:center;margin-bottom:2px;"><span class="status-dot" style="background:#fd7e14;"></span>Monitoring</div>
            <div style="display:flex;align-items:center;"><span style="color:red;font-weight:bold;margin-right:5px;">‚úñ</span>Damaged</div>
        </div>
    </div>

    <script>
        var API_URL = localStorage.getItem("bsm_api_url");
        var currentSheet = "", map, markers = [], zoneLayerGroup = L.layerGroup();
        var measureMode = false, measurePoints = [], measureLayerGroup = L.layerGroup();
        var gpsActive = false, userMarker = null, gpsWatchId = null;
        var controlTypes = new Set(["Benchmark", "Control Point", "Check Point", "I & M Control point", "TBM"]);
        var HK1980_DEF = "+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.1785555555556 +k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +towgs84=-162.619,-276.959,-161.764,0.067753,-2.24365,-1.15883,-1.09425 +units=m +no_defs";
        proj4.defs("EPSG:2326", HK1980_DEF);

        window.onload = function() { if(!API_URL) { document.getElementById('loading-overlay').style.display = 'none'; document.getElementById('setup-box').style.display = 'block'; } else fetchSheetNames(); };

        function saveURL() { var url = document.getElementById('url-input').value.trim(); if(url) { localStorage.setItem("bsm_api_url", url); API_URL = url; location.reload(); } }
        function resetURL() { localStorage.removeItem("bsm_api_url"); location.reload(); }
        function fetchSheetNames() { fetch(API_URL, {method: 'POST', body: JSON.stringify({action: 'get_sheet_names'})}).then(res => res.json()).then(names => { var grid = document.getElementById('menu-grid'); grid.innerHTML = ""; names.forEach(name => { var btn = document.createElement('button'); btn.className = 'menu-btn'; btn.onclick = () => loadProject(name); btn.innerHTML = `<span>${name}</span>`; grid.appendChild(btn); }); document.getElementById('loading-overlay').style.display = 'none'; }); }
        function loadProject(name) { currentSheet = name; document.getElementById('loading-overlay').style.display = 'flex'; fetch(API_URL, {method: 'POST', body: JSON.stringify({action: 'get_data', sheet: name})}).then(res => res.json()).then(data => { document.getElementById('home-screen').style.display = 'none'; document.getElementById('map-container').style.display = 'block'; initMap(data); document.getElementById('loading-overlay').style.display = 'none'; }); }

        function initMap(data) {
            if(map) map.remove();
            map = L.map('map', { zoomControl: false, maxZoom: 24 });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 24, maxNativeZoom: 19 }).addTo(map);
            measureLayerGroup.addTo(map); zoneLayerGroup.addTo(map);
            
            var bounds = L.latLngBounds(), uZones = new Set(), uTypes = new Set();
            markers = [];

            data.forEach(p => {
                uZones.add(p.z || "Other");
                var isControl = controlTypes.has(p.t);
                if(isControl) uTypes.add("Control Point"); else uTypes.add(p.t || "Other");

                var finalN = p.an || p.pn, finalE = p.ae || p.pe;
                if(!finalN || !finalE) return;

                var wgs = proj4("EPSG:2326", "EPSG:4326", [finalE, finalN]);
                var latlng = [wgs[1], wgs[0]]; bounds.extend(latlng);

                var color = (p.init) ? '#fd7e14' : (p.d) ? '#00e600' : 'red';
                var marker;
                
                // ‰øÆÊîπËôïÔºöÁßªÈô§‰∏âËßíÂΩ¢ÔºåControl Point ÊîπÁÇ∫ÂúìÂΩ¢ 
                if(p.dmg === true) marker = L.marker(latlng, { icon: L.divIcon({ className: 'damaged-icon', html: '‚úñ' }) });
                else marker = L.circleMarker(latlng, { radius: 7, fillColor: color, color: 'white', weight: 2, fillOpacity: 1 });

                marker.bindTooltip(String(p.id), { permanent: true, direction: 'top', className: 'blue-label' });
                marker.bindPopup("Loading...");
                marker.on('click', (e) => { if(!measureMode) e.target.setPopupContent(generatePopupHtml(markers.find(m => m.id == p.id))); });

                markers.push({ id: String(p.id), zone: String(p.z||"Other"), type: p.t, isControl: isControl, layer: marker, latlng: latlng, freq: p.freq || "None", d: p.d, init: p.init });
                marker.addTo(map);
            });
            if(markers.length > 0) map.fitBounds(bounds);
            setupFilters(uZones, uTypes); drawZoneBoundaries();
        }

        // ‰øÆÊîπËôïÔºöControl Point ‰∏çË®àÂÖ• Zone ÈÇäÁïå 
        function drawZoneBoundaries() {
            zoneLayerGroup.clearLayers();
            var uniqueZones = new Set(); markers.forEach(m => uniqueZones.add(m.zone));
            uniqueZones.forEach(z => {
                var pts = [];
                markers.forEach(m => { if (m.zone === z && !m.isControl) pts.push({lat: m.latlng[0], lng: m.latlng[1]}); });
                if (pts.length < 3) return;
                var hull = convexHull(pts), latlngs = hull.map(p => [p.lat, p.lng]);
                L.polygon(latlngs, { color: 'purple', weight: 2, fillOpacity: 0.1, interactive: false }).addTo(zoneLayerGroup);
            });
        }

        // ‰øÆÊîπËôïÔºöÊñ∞Â¢ûÁï∂ÂâçË¶ñËßíÊâìÂç∞ 
        function openPrintView(mode) {
            closePrintOptionsModal();
            var contentDiv = document.getElementById('print-content');
            document.getElementById('print-date').innerText = "Generated: " + new Date().toLocaleString();
            contentDiv.innerHTML = "";

            var mapBounds = map.getBounds();
            var targetMarkers = markers.filter(m => {
                var isVisible = map.hasLayer(m.layer);
                if (mode === 'currentView') return isVisible && mapBounds.contains(m.layer.getLatLng());
                return isVisible;
            });

            var byFreq = {};
            targetMarkers.forEach(m => {
                var f = m.freq || "No Frequency";
                if(!byFreq[f]) byFreq[f] = []; byFreq[f].push(m);
            });

            Object.keys(byFreq).sort().forEach(fName => {
                var block = document.createElement('div'); block.className = 'report-freq-block';
                block.innerHTML = `<div class="report-freq-header">${fName}</div>`;
                var table = document.createElement('div'); table.className = 'report-details-table';
                var byType = {};
                byFreq[fName].forEach(m => { if(!byType[m.type]) byType[m.type]=[]; byType[m.type].push(m.id); });
                Object.keys(byType).sort().forEach(tName => {
                    var ids = byType[tName].sort();
                    var idStr = (mode === 'simple') ? formatIdsSimple(ids) : ids.join(', ');
                    table.innerHTML += `<div class="report-type-row"><div class="report-type-cell">${tName}</div><div class="report-points-cell">${idStr}</div></div>`;
                });
                block.appendChild(table); contentDiv.appendChild(block);
            });
            document.getElementById('print-container').style.display = 'block';
        }

        // ÂÖ∂‰ªñÂäüËÉΩ [cite: 145-146, 290-414]
        function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function toggleMenu() { document.getElementById('expandable-btns').classList.toggle('show'); }
        function goHome() { location.reload(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function toggleMeasure() { measureMode = !measureMode; document.getElementById('measure-box').style.display = measureMode?'block':'none'; }
        function clearMeasure() { measureLayerGroup.clearLayers(); measurePoints = []; }
        function toggleZoneBoundaries() { if(map.hasLayer(zoneLayerGroup)) map.removeLayer(zoneLayerGroup); else map.addLayer(zoneLayerGroup); }
        function openPrintOptionsModal() { document.getElementById('print-options-overlay').style.display='flex'; }
        function closePrintOptionsModal() { document.getElementById('print-options-overlay').style.display='none'; }
        function closePrintView() { document.getElementById('print-container').style.display='none'; }
        function reloadMap() { loadProject(currentSheet); }
        function generatePopupHtml(m) { return `<div style="font-weight:bold;">${m.id}</div><div>Type: ${m.type}</div><button onclick="openInstallModal('${m.id}')" style="margin-top:5px;width:100%;">Install</button>`; }
        function openInstallModal(id) { currentEditingId = id; document.getElementById('update-modal-overlay').style.display='flex'; }
        function closeModal() { document.getElementById('update-modal-overlay').style.display='none'; }
        function saveInstall() { var date = document.getElementById('install-date-picker').value; fetch(API_URL, {method:'POST', body:JSON.stringify({action:'update', sheet:currentSheet, id:currentEditingId, date:date})}).then(()=>reloadMap()); closeModal(); }

        function setupFilters(zones, types) {
            var zc = document.getElementById('zone-items'), tc = document.getElementById('type-items');
            zc.innerHTML = ""; tc.innerHTML = "";
            zones.forEach(z => zc.innerHTML += `<li class="check-label"><input type="checkbox" class="zone-chk" value="${z}" checked onchange="applyFilter()">${z}</li>`);
            types.forEach(t => tc.innerHTML += `<li class="check-label"><input type="checkbox" class="type-chk" value="${t}" checked onchange="applyFilter()">${t}</li>`);
        }
        function applyFilter() {
            var search = document.getElementById('search-input').value.toUpperCase();
            var selZones = Array.from(document.querySelectorAll('.zone-chk:checked')).map(c=>c.value);
            var selTypes = Array.from(document.querySelectorAll('.type-chk:checked')).map(c=>c.value);
            markers.forEach(m => {
                var match = selZones.includes(m.zone) && (selTypes.includes(m.type) || (m.isControl && selTypes.includes("Control Point"))) && m.id.toUpperCase().includes(search);
                if(match) map.addLayer(m.layer); else map.removeLayer(m.layer);
            });
        }
        function toggleDropdown(id) { document.getElementById(id+'-dropdown').classList.toggle('visible'); }
        function convexHull(points) {
            points.sort((a,b) => a.lat != b.lat ? a.lat - b.lat : a.lng - b.lng);
            var lower = []; for(var i=0; i<points.length; i++) { while(lower.length>=2 && crossProduct(lower[lower.length-2], lower[lower.length-1], points[i])<=0) lower.pop(); lower.push(points[i]); }
            var upper = []; for(var i=points.length-1; i>=0; i--) { while(upper.length>=2 && crossProduct(upper[upper.length-2], upper[upper.length-1], points[i])<=0) upper.pop(); upper.push(points[i]); }
            upper.pop(); lower.pop(); return lower.concat(upper);
        }
        function crossProduct(o,a,b) { return (a.lng - o.lng) * (b.lat - o.lat) - (a.lat - o.lat) * (b.lng - o.lng); }
        function formatIdsSimple(ids) {
            if(!ids.length) return "";
            var res = [], i = 0;
            while(i < ids.length) {
                var start = ids[i], j = i;
                while(j + 1 < ids.length && isNext(ids[j], ids[j+1])) j++;
                if(j > i) res.push(start + " ~ " + ids[j]); else res.push(start);
                i = j + 1;
            }
            return res.join(', ');
        }
        function isNext(a, b) {
            var ma = a.match(/\d+$/), mb = b.match(/\d+$/);
            if(!ma || !mb) return false;
            return parseInt(ma[0])+1 === parseInt(mb[0]);
        }
        function toggleGPS() {
            if(!gpsActive) {
                gpsActive = true; document.getElementById('gps-btn').classList.add('active');
                gpsWatchId = navigator.geolocation.watchPosition(p => {
                    var latlng = [p.coords.latitude, p.coords.longitude];
                    if(!userMarker) userMarker = L.marker(latlng).addTo(map); else userMarker.setLatLng(latlng);
                    map.setView(latlng);
                });
            } else {
                gpsActive = false; document.getElementById('gps-btn').classList.remove('active');
                navigator.geolocation.clearWatch(gpsWatchId); map.removeLayer(userMarker); userMarker = null;
            }
        }
    </script>
</body>
</html>
