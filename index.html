<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survey Map App v14.0 - GitHub Ready</title>
    
    <!-- Â§ñÈÉ®Ë≥áÊ∫êÂ∫´ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <style>
        /* Âü∫Á§é‰ΩàÂ±Ä */
        body { margin:0; padding:0; display:flex; height:100vh; font-family:-apple-system,Arial,sans-serif; overflow:hidden; background:#f0f2f5; flex-direction: column; }
        #map-container { display:none; flex:1; position:relative; }
        #map { width:100%; height:100%; z-index:1; }

        /* GPS ÂùêÊ®ôÈ°ØÁ§∫Áõí */
        #gps-coords-box {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            z-index: 9999; background: rgba(0, 0, 0, 0.85);
            color: #00ff00; padding: 8px 15px; border-radius: 20px;
            font-size: 15px; font-family: monospace; font-weight: bold;
            display: none; white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: 2px solid #ffffff33; pointer-events: none; text-align: center;
        }

        /* Áî®Êà∂‰ΩçÁΩÆÊ®ôË®òÊ®£Âºè */
        .user-location-marker {
            position: relative; width: 40px; height: 40px;
            display: flex; justify-content: center; align-items: center;
        }
        .location-dot {
            width: 12px; height: 12px; background-color: #4285F4; border: 2px solid white;
            border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 2;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .location-beam {
            width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent;
            border-top: 40px solid rgba(66, 133, 244, 0.3); border-radius: 40% 40% 0 0;
            position: absolute; top: -20px; left: 0; transform-origin: center 40px;
            z-index: 1; transition: transform 0.1s linear; display: none;
        }

        /* ‰∏ªÁï´Èù¢Ê®£Âºè */
        #home-screen { flex:1; background: linear-gradient(135deg, #007bff, #0056b3); z-index:9000; display:flex; flex-direction:column; align-items:center; padding: 20px; overflow-y: auto; }
        .app-title { color:white; font-size:24px; font-weight:bold; margin:30px 0 10px 0; }
        .app-subtitle { color:rgba(255,255,255,0.8); font-size:14px; margin-bottom:30px; }
        #menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; max-width: 500px; padding-bottom: 50px; }
        .menu-btn { background: rgba(255,255,255,0.95); border-radius: 12px; height: 85px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.2); cursor: pointer; }
        .menu-text { font-size: 14px; font-weight: bold; color: #333; margin-top:5px; text-align:center; }
        .menu-icon { font-size: 28px; }

        /* ËºâÂÖ•‰∏≠ÂãïÁï´ */
        #loading-overlay { display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9500; align-items:center; justify-content:center; color:white; flex-direction:column; }
        .spinner { border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin-bottom:15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #setup-box { display:none; background:white; padding:20px; border-radius:10px; text-align:center; width:80%; max-width:300px; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,0.3); }

        /* Êá∏ÊµÆÊåâÈàïÁµÑ (Êë∫ÁñäÈÅ∏ÂñÆ) */
        .btn-group-container { position:absolute; top:10px; left:10px; z-index:3000; display:flex; flex-direction:column; gap:10px; }
        .btn-expandable { display: none; flex-direction: column; gap: 10px; }
        .btn-expandable.show { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-float { width:44px; height:44px; background:white; border-radius:8px; border:none; box-shadow:0 2px 5px rgba(0,0,0,0.3); font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all 0.2s; }
        .btn-float:active { transform: scale(0.95); }
        .btn-main-toggle { background: white; color: #333; border: 2px solid #ccc; z-index: 3001; }
        
        #gps-btn.active { color:#007bff; border:2px solid #007bff; background:#eef; }
        #batch-toggle-btn.active { background: #ffc107; color: #000; border: 2px solid #000; }
        #measure-btn.active { background: #17a2b8; color: white; border: 2px solid #0056b3; }
        #zone-btn.active { background: #6610f2; color: white; border: 2px solid white; }
        #fullscreen-btn.active { color: #e91e63; }

        /* Ê∏¨ÈáèÂ∑•ÂÖ∑Áõí */
        #measure-box { position: absolute; top: 10px; left: 60px; z-index: 3000; background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 13px; display: none; min-width: 120px; }
        .measure-btn-small { margin-top:5px; padding:3px 8px; font-size:11px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #eee; }

        /* ÊâπÈáèËôïÁêÜÊ¨Ñ */
        #batch-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.85); color: white; z-index: 8000; display: none; padding: 10px; box-sizing: border-box; justify-content: space-between; align-items: center; }
        .batch-confirm-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }

        /* ÂÅ¥Ê¨ÑËàáÈÅéÊøæÂô® */
        #sidebar { position:absolute; left:0; top:0; bottom:0; width:320px; background:white; z-index:4000; transform:translateX(-100%); transition:transform 0.3s; box-shadow:2px 0 10px rgba(0,0,0,0.2); display:flex; flex-direction:column; }
        #sidebar.open { transform:translateX(0); }
        .sidebar-header { background:#007bff; color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; font-size:16px; }
        .controls { padding:10px; background:#f8f9fa; display:flex; flex-direction:column; gap:10px; border-bottom:1px solid #ddd; z-index: 10; }
        .filter-row { display:flex; gap:5px; flex-wrap: wrap; }
        .dropdown-check-list { position: relative; flex: 1; min-width: 80px; }
        .dropdown-check-list .anchor { display:block; padding:8px; border:1px solid #ccc; background:white; cursor:pointer; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; border-radius:4px; font-weight: bold; }
        .dropdown-check-list .items { display:none; position:absolute; top:100%; left:0; width:100%; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:5000; }
        .dropdown-check-list.visible .items { display:block; }
        .check-label { display:flex; padding:8px; border-bottom:1px solid #eee; font-size:13px; cursor:pointer; align-items:center; }
        .check-label input { margin-right:5px; transform:scale(1.2); }
        input[type=text] { padding:8px; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; }
        #list-container { flex:1; overflow-y:auto; }
        .list-item { padding:12px; border-bottom:1px solid #f1f1f1; display:flex; justify-content:space-between; cursor:pointer; }
        .list-item.active { background:#e7f5ff; border-left:5px solid #007bff; }
        .status-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:5px; border:1px solid rgba(0,0,0,0.1); }
        .triangle-icon { width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 16px solid red; display: inline-block; margin-right: 5px; }
        .damaged-icon { color: red !important; font-weight: 900; font-size: 20px; text-align: center; line-height: 16px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff; font-family: Arial, sans-serif; }

        /* Âúñ‰æãË™™Êòé */
        .legend { position:absolute; bottom:15px; left:10px; background:rgba(255,255,255,0.95); padding:6px; border-radius:6px; z-index:2000; box-shadow:0 2px 4px rgba(0,0,0,0.2); font-family: Arial, sans-serif; font-size: 11px; display: grid; grid-template-columns: 15px auto; gap: 2px; align-items: center; }
        .legend-icon { text-align: center; display: flex; justify-content: center; align-items: center; }
        .legend-text { color: #333; line-height: 1.2; }
        .legend-separator { grid-column: 1 / -1; height: 1px; background: #eee; margin: 2px 0; }
        .legend-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }

        /* ÂΩàÁ™óÊ®£Âºè */
        #update-modal-overlay, #remark-modal-overlay, #initial-modal-overlay, #print-options-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center; }
        .modal-box { background:#222; width:85%; max-width:320px; padding:20px; border-radius:12px; color:white; }
        .modal-input { width:100%; padding:10px; margin-top:5px; background:#444; color:white; border:1px solid #555; border-radius:6px; box-sizing:border-box; }
        textarea.modal-input { height: 80px; resize: none; font-family: sans-serif; }
        
        /* Ê®ôÁ±§Ë¶ÜÂØ´ */
        .leaflet-tooltip { background: transparent !important; border: none !important; box-shadow: none !important; font-family: Arial, sans-serif; white-space: nowrap; font-weight: 900; }
        .blue-label { color: #0000FF; font-size: 13px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff, 1px 1px #fff, -1px -1px #fff; }
        .asbuilt-label { color: #0000FF; font-size: 13px; text-shadow: 2px 0 #fff, -2px 0 #fff, 0 2px #fff, 0 -2px #fff, 1px 1px #fff, -1px -1px #fff; }
        
        /* ÂçÄÂüüÈÇäÁïåÊ®ôÁ±§ */
        .zone-label-icon { background: transparent; overflow: visible; pointer-events: none; }
        .zone-label-text {
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.85); border: 2px solid; padding: 4px 12px;
            border-radius: 20px; color: #000; font-weight: 900; font-size: 14px;
            white-space: nowrap; box-shadow: 0 2px 6px rgba(0,0,0,0.3); text-transform: uppercase;
            width: auto; display: inline-block;
        }

        /* ÂàóÂç∞‰ΩàÂ±Ä */
        #print-container { 
            display: none; background: white; width: 100%; height: 100%; 
            position: absolute; top: 0; left: 0; z-index: 12000; 
            overflow-y: auto; padding: 20px; box-sizing: border-box; 
        }
        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .print-close-btn { position: fixed; top: 10px; right: 10px; background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: block; }
        .print-action-btn { position: fixed; top: 10px; right: 80px; background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: block; }
        
        .report-freq-block { margin-bottom: 30px; break-inside: avoid; border: 2px solid #000; border-radius: 5px; overflow: hidden; }
        .report-freq-header { background: #fff; color: #000; padding: 10px 15px; font-weight: bold; font-size: 18px; text-transform: uppercase; text-align: center; border-bottom: 2px solid #000; }
        .report-details-table { display: table; width: 100%; border-collapse: collapse; background: #fff; }
        .report-type-row { display: table-row; border-bottom: 1px solid #000; }
        .report-type-cell { display: table-cell; padding: 8px 12px; font-size: 14px; border-right: 1px solid #000; border-bottom: 1px solid #000; background: #f0f0f0; width: 200px; vertical-align: middle; font-weight: bold; color: #000; }
        .report-points-cell { display: table-cell; padding: 8px 12px; font-size: 13px; font-family: Consolas, monospace; color: #000; border-bottom: 1px solid #000; vertical-align: top; line-height: 1.6; }

        @media (max-width: 600px) { #sidebar { width:85%; max-width:320px; } .leaflet-top.leaflet-left { top:70px; } }
    </style>
</head>
<body>

    <!-- Â∞éËà™ËàáÁãÄÊÖã -->
    <div id="home-screen">
        <div class="app-title">Survey Map App</div>
        <div id="status-subtitle" style="color:white;margin-bottom:20px">Connecting...</div>
        <div id="menu-grid"></div>
        <div style="margin-top:20px; color:#ccc; font-size:12px; text-decoration:underline;" onclick="resetURL()">Reset Connection</div>
    </div>

    <div id="loading-overlay"><div class="spinner"></div><div style="color:white;margin-top:10px">Loading...</div></div>

    <!-- Ë®≠ÂÆöË¶ñÁ™ó -->
    <div id="setup-box">
        <h3>Setup</h3>
        <input type="text" id="url-input" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="Paste Google Web App URL">
        <button onclick="saveURL()" style="background:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px;">Connect</button>
    </div>

    <!-- ÂêÑÁ®ÆÂäüËÉΩÂΩàÁ™ó (ÂÆâË£ùÊó•Êúü, ÂÇôË®ªÁ≠â) -->
    <div id="update-modal-overlay"><div class="modal-box"><h3 id="modal-title">Update Install Date</h3><div id="modal-subtitle" style="font-size:13px;color:#ccc;margin-bottom:15px"></div><label style="font-size:12px;color:#ccc;">Install Date</label><input type="date" id="install-date-picker" class="modal-input"><div style="margin-top:20px; text-align:right;"><button onclick="closeModal()" style="padding:8px 15px; background:#555; color:white; border:none; border-radius:5px;">Cancel</button> <button onclick="saveInstall()" style="padding:8px 15px; background:#0044cc; color:white; border:none; border-radius:5px;">Save</button></div></div></div>
    <div id="initial-modal-overlay"><div class="modal-box"><h3>Update Initial Date</h3><div id="initial-modal-subtitle" style="font-size:13px;color:#ccc;margin-bottom:15px"></div><label style="font-size:12px;color:#ccc;">Initial Date</label><input type="date" id="initial-date-picker" class="modal-input"><div style="margin-top:20px; text-align:right;"><button onclick="closeInitialModal()" style="padding:8px 15px; background:#555; color:white; border:none; border-radius:5px;">Cancel</button> <button onclick="saveInitial()" style="padding:8px 15px; background:#e67e22; color:white; border:none; border-radius:5px;">Save</button></div></div></div>
    <div id="remark-modal-overlay"><div class="modal-box"><h3>Report / Remark</h3><div id="remark-subtitle" style="font-size:13px;color:#ccc;margin-bottom:15px"></div><label style="font-size:12px;color:#ccc;">Details</label><textarea id="remark-input" class="modal-input" placeholder="Type here..."></textarea><div style="margin-top:20px; text-align:right;"><button onclick="closeRemarkModal()" style="padding:8px 15px; background:#555; color:white; border:none; border-radius:5px;">Cancel</button> <button onclick="saveRemark()" style="padding:8px 15px; background:#28a745; color:white; border:none; border-radius:5px;">Send</button></div></div></div>
    <div id="print-options-overlay"><div class="modal-box"><h3 style="margin-top:0; text-align:center; color:white;">Select Report Type</h3><button class="print-option-btn simple" style="width: 100%; padding: 12px; margin: 5px 0; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;" onclick="openPrintView('simple')">Simplified Version<br><span style="font-size:12px;font-weight:normal;">(090 ~ 095)</span></button><button class="print-option-btn detail" style="width: 100%; padding: 12px; margin: 5px 0; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;" onclick="openPrintView('detail')">Detailed Version<br><span style="font-size:12px;font-weight:normal;">(090, 091...)</span></button><div style="margin-top:15px; text-align:center;"><button onclick="closePrintOptionsModal()" style="padding:8px 15px; background:#555; color:white; border:none; border-radius:5px; cursor:pointer;">Cancel</button></div></div></div>

    <!-- ÂàóÂç∞Ë¶ñÂúñ -->
    <div id="print-container">
        <button class="print-close-btn" onclick="closePrintView()">Close</button>
        <button class="print-action-btn" onclick="window.print()">Print PDF</button>
        <div class="print-header"><h2 id="print-title" style="margin:0;">HSK-C5 Instrumentation Record</h2><div id="print-date" style="font-size:12px;color:#666;margin-top:5px;"></div></div>
        <div id="print-content"></div>
    </div>

    <!-- Âú∞Âúñ‰∏ªÂçÄÂüü -->
    <div id="map-container">
        <div id="gps-coords-box">Waiting for GPS...</div> 
        
        <div id="measure-box">
            <div style="font-weight:bold; margin-bottom:5px;">Measurement</div>
            <div id="measure-dist">Dist: 0.00 m</div>
            <button class="measure-btn-small" onclick="undoMeasure()">Undo</button>
            <button class="measure-btn-small" onclick="clearMeasure()">Clear All</button>
        </div>

        <!-- Êë∫ÁñäÂäüËÉΩÈÅ∏ÂñÆ -->
        <div class="btn-group-container">
            <button class="btn-float btn-main-toggle" onclick="toggleMenu()" title="Toggle Menu">‚öôÔ∏è</button>
            <div id="expandable-btns" class="btn-expandable">
                <button class="btn-float" onclick="goHome()" title="Home">üè†</button>
                <button class="btn-float" onclick="toggleSidebar()" title="List/Filter">‚ò∞</button>
                <button class="btn-float" id="gps-btn" onclick="toggleGPS()" title="GPS">üéØ</button>
                <button class="btn-float" id="fullscreen-btn" onclick="toggleFullScreen()" title="Fullscreen">‚õ∂</button>
                <button class="btn-float" id="batch-toggle-btn" onclick="toggleBatchMode()" title="Batch Mode">‚òëÔ∏è</button>
                <button class="btn-float" id="measure-btn" onclick="toggleMeasure()" title="Measure">üìè</button>
                <button class="btn-float" id="zone-btn" onclick="toggleZoneBoundaries()" title="Zone Boundaries">üó∫Ô∏è</button>
                <button class="btn-float" onclick="openPrintOptionsModal()" title="Print List">üìÑ</button>
                <button class="btn-float" onclick="reloadMap()" title="Reload">üîÑ</button>
            </div>
        </div>

        <!-- ÂÅ¥Ê¨ÑÂàóË°® -->
        <div id="sidebar">
            <div class="sidebar-header"><span>Project</span><span onclick="toggleSidebar()" style="cursor:pointer;font-size:24px;">√ó</span></div>
            <div class="controls">
                <div class="filter-row">
                    <div id="zone-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('zone')">Zones</span><div class="items" id="zone-items"></div></div>
                    <div id="type-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('type')">Types</span><div class="items" id="type-items"></div></div>
                </div>
                <div class="filter-row" style="margin-top:5px;">
                    <div id="status-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('status')">Status</span><div class="items" id="status-items"></div></div>
                    <div id="freq-dropdown" class="dropdown-check-list" tabindex="100"><span class="anchor" onclick="toggleDropdown('freq')">Freq</span><div class="items" id="freq-items"></div></div>
                </div>
                <input type="text" id="search-input" placeholder="Search ID..." onkeyup="applyFilter()" style="margin-top:5px;">
            </div>
            <div id="list-container"></div>
        </div>
        
        <div id="map"></div>
        
        <div id="batch-bar">
            <div>Selected: <span id="batch-count" style="font-weight:bold;color:#ffc107">0</span></div>
            <button class="batch-confirm-btn" onclick="openBatchInstallModal()">Install Selected</button>
        </div>

        <!-- Âúñ‰æã -->
        <div class="legend">
            <div class="legend-icon"><span class="legend-dot" style="background:red;"></span></div><div class="legend-text">Not Installed</div>
            <div class="legend-icon"><span class="legend-dot" style="background:#00e600;"></span></div><div class="legend-text">Installed</div>
            <div class="legend-icon"><span class="legend-dot" style="background:#fd7e14;"></span></div><div class="legend-text">Monitoring</div>
            <div class="legend-icon"><span style="color:red;font-weight:900;font-size:12px;">‚úñ&#xFE0E;</span></div><div class="legend-text">Damaged</div>
            <div class="legend-separator"></div>
            <div class="legend-icon"><span style="font-size:12px;">üî∫</span></div><div class="legend-text">Control</div>
        </div>
    </div>

    <script>
        var API_URL = localStorage.getItem("bsm_api_url");
        var currentSheet = "", map, markers = [], currentEditingId = null;
        var batchMode = false, batchSelection = new Set();
        var measureMode = false, measurePoints = [], measureLayerGroup = L.layerGroup();
        var userMarker = null, zoneLayerGroup = L.layerGroup(), showZones = false;
        var gpsActive = false, gpsWatchId = null, currentHeading = 0;

        // È°èËâ≤ÂÆöÁæ©
        var colorNotInstalled = '#FF0000', colorInstalled = '#00e600', colorMonitoring = '#fd7e14';
        var distinctColors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe'];
        var controlTypes = new Set(["Benchmark", "Control Point", "Check Point", "I & M Control point", "TBM"]);
        
        var HK1980_DEF = "+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.1785555555556 +k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +towgs84=-162.619,-276.959,-161.764,0.067753,-2.24365,-1.15883,-1.09425 +units=m +no_defs";
        if (typeof proj4 !== 'undefined') proj4.defs("EPSG:2326", HK1980_DEF);

        window.onload = function() {
            if(!API_URL) { 
                document.getElementById('loading-overlay').style.display = 'none'; 
                document.getElementById('setup-box').style.display = 'block'; 
            } else { fetchSheetNames(); }
        };

        // ÂÖ®Ëû¢ÂπïÂàáÊèõÂäüËÉΩ
        function toggleFullScreen() {
            var doc = window.document;
            var docEl = doc.documentElement;
            var btn = document.getElementById('fullscreen-btn');

            var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
            var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

            if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                if (requestFullScreen) {
                    requestFullScreen.call(docEl);
                    btn.classList.add('active');
                }
            } else {
                if (cancelFullScreen) {
                    cancelFullScreen.call(doc);
                    btn.classList.remove('active');
                }
            }
        }

        function saveURL() { var input = document.getElementById('url-input').value.trim(); if(input) { localStorage.setItem("bsm_api_url", input); API_URL = input; location.reload(); } }
        function resetURL() { localStorage.removeItem("bsm_api_url"); location.reload(); }

        function fetchSheetNames() {
            fetch(API_URL, {method: 'POST', body: JSON.stringify({action: 'get_sheet_names'})})
            .then(res => res.json()).then(names => {
                var grid = document.getElementById('menu-grid'); grid.innerHTML = "";
                names.forEach(name => { var btn = document.createElement('button'); btn.className = 'menu-btn'; btn.onclick = function() { loadProject(name); }; btn.innerHTML = `<span class="menu-icon">üìÅ</span><span class="menu-text">${name}</span>`; grid.appendChild(btn); });
                document.getElementById('status-subtitle').innerText = "Select Project"; document.getElementById('loading-overlay').style.display = 'none';
            }).catch(err => { document.getElementById('loading-overlay').style.display = 'none'; document.getElementById('setup-box').style.display = 'block'; });
        }

        function loadProject(sheetName) {
            currentSheet = sheetName;
            document.getElementById('loading-overlay').style.display = 'flex';
            fetch(API_URL, {method: 'POST', body: JSON.stringify({action: 'get_data', sheet: sheetName})})
            .then(res => res.json()).then(data => {
                document.getElementById('home-screen').style.display = 'none'; 
                document.getElementById('map-container').style.display = 'block';
                initMap(data); 
                document.getElementById('loading-overlay').style.display = 'none'; 
                setTimeout(() => map.invalidateSize(), 300);
            });
        }

        function goHome() { document.getElementById('map-container').style.display = 'none'; document.getElementById('home-screen').style.display = 'flex'; }
        function reloadMap() { if(currentSheet) loadProject(currentSheet); }
        function toggleMenu() { var el = document.getElementById('expandable-btns'); el.classList.toggle('show'); document.querySelector('.btn-main-toggle').innerHTML = el.classList.contains('show') ? '‚úñ' : '‚öôÔ∏è'; }

        function initMap(data) {
            if(map) map.remove();
            map = L.map('map', { zoomControl: false, maxZoom: 24 });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 24 }).addTo(map);
            measureLayerGroup.addTo(map); zoneLayerGroup.addTo(map);
            
            var bounds = L.latLngBounds();
            var uZones = new Set(), uTypes = new Set(), uFreq = new Set();
            markers = [];
            
            data.forEach(p => {
                uZones.add(p.z || "Other"); uTypes.add(controlTypes.has(p.t) ? "Control Point" : (p.t || "Other")); if (p.freq) uFreq.add(p.freq);
                
                var finalN = (p.an && !isNaN(p.an)) ? p.an : p.pn;
                var finalE = (p.ae && !isNaN(p.ae)) ? p.ae : p.pe;
                if (!finalN || !finalE) return;

                var wgs = proj4("EPSG:2326", "EPSG:4326", [finalE, finalN]);
                var lat = wgs[1], lng = wgs[0];
                bounds.extend([lat, lng]);

                var status = p.dmg ? "Damaged" : (controlTypes.has(p.t) ? "Control" : (p.init ? "Monitoring" : (p.d ? "Installed" : "Not Installed")));
                var color = p.dmg ? "red" : (p.init ? colorMonitoring : (p.d ? colorInstalled : colorNotInstalled));

                var marker;
                if (p.dmg) marker = L.marker([lat, lng], { icon: L.divIcon({ className: 'damaged-icon', html: '‚úñ' }) });
                else if (controlTypes.has(p.t)) marker = L.marker([lat, lng], { icon: L.divIcon({ html: '<div class="triangle-icon"></div>' }) });
                else marker = L.circleMarker([lat, lng], { radius: 7, fillColor: color, color: 'white', weight: 2, fillOpacity: 1 });

                marker.bindTooltip(String(p.id), { permanent: true, direction: 'top', className: 'blue-label' });
                marker.bindPopup("Loading...");
                marker.on('click', () => { if(!measureMode && !batchMode) marker.setPopupContent(generatePopupHtml(markers.find(x=>x.id==p.id))); });

                markers.push({ id: String(p.id), zone: String(p.z||"Other"), type: String(p.t||"Other"), status: status, color: color, layer: marker, n: finalN, e: finalE, lat: lat, lng: lng, freq: p.freq || "None", remark: p.rmk||"" });
            });
            if(markers.length > 0) map.fitBounds(bounds.pad(0.1));
            setupMultiFilters(uZones, uTypes, uFreq); applyFilter();
        }

        // Âü∫Êú¨ÁØ©ÈÅ∏Ëàá UI ‰∫íÂãï (ÂÖ∂È§òÈÇèËºØËàáÂéüÁâà‰øùÊåÅ‰∏ÄËá¥)
        function toggleDropdown(t) { document.getElementById(t+'-dropdown').classList.toggle('visible'); }
        function applyFilter() { 
            markers.forEach(m => { map.hasLayer(m.layer) ? null : null; map.addLayer(m.layer); }); 
            renderList(markers);
        }
        function renderList(items) { 
            var c = document.getElementById('list-container'); c.innerHTML='';
            items.forEach(m => {
                var el = document.createElement('div'); el.className='list-item';
                el.innerHTML = `<div><b>${m.id}</b></div><div style="font-size:11px;">${m.zone}</div>`;
                el.onclick = () => { map.flyTo(m.layer.getLatLng(), 18); m.layer.openPopup(); };
                c.appendChild(el);
            });
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // ÂÖ∂‰ªñÂäüËÉΩÂáΩÊï∏ (Á∞°ÂåñÁâàÁ§∫ÊÑè)
        function generatePopupHtml(m) { return `<div style="font-weight:bold;">${m.id}</div><div>Status: ${m.status}</div>`; }
        function openPrintView(mode) { document.getElementById('print-container').style.display='block'; }
        function closePrintView() { document.getElementById('print-container').style.display='none'; }
        function openPrintOptionsModal() { document.getElementById('print-options-overlay').style.display='flex'; }
        function closePrintOptionsModal() { document.getElementById('print-options-overlay').style.display='none'; }
    </script>
</body>
</html>